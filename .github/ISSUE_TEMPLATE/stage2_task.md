---
name: ステージ2タスク
about: ステージ2（チャットルーム機能）の実装タスク
title: '[STAGE2] '
labels: ['task', 'stage-2']
assignees: ''
---

## 📋 タスク概要
**タスク番号**: [例: 10, 11, 12]
**タスク名**: [例: TCRPプロトコルの実装]

## 🎯 実装内容
<!-- ステージ2固有の実装内容を詳しく説明してください -->

### 主要な実装項目
- [ ] TCRPメッセージフォーマットの実装
- [ ] pack()/unpack()を使用した32バイトヘッダーの解析
- [ ] 操作コード処理（1: ルーム作成, 2: ルーム参加）
- [ ] TCP/UDP二重プロトコルシステムの実装

## 📝 関連要件
<!-- ステージ2の要件を記載 -->
- 要件6.1: 32バイトのヘッダーを含む
- 要件6.2: 最大28バイトまでのUTF-8エンコードされた名前をサポート
- 要件6.3: 新しいチャットルームを作成する場合は操作コード1を使用
- 要件6.4: チャットルームに参加する場合は操作コード2を使用

## 🔧 技術仕様

### TCRPプロトコル仕様
```
ヘッダー (32 bytes):
[RoomNameSize: 1byte][Operation: 1byte][State: 1byte][OperationPayloadSize: 29bytes]

操作コード:
- 1: ルーム作成
- 2: ルーム参加

状態コード:
- 0: リクエスト
- 1: 応答
- 2: 完了
```

### デュアルプロトコルシステム
- **TCP**: チャットルーム管理（作成、参加、認証）
- **UDP**: リアルタイムメッセージング（パフォーマンス重視）

### パフォーマンス要件
- [ ] 処理速度: 10,000+ packets/second
- [ ] 同時チャットルーム数: 500+
- [ ] ルーム管理レスポンス: <50ms
- [ ] メッセージング遅延: <10ms

## 🏗️ 実装アプローチ

### 主要クラス・関数
- `TcpServer`: チャットルーム管理サーバ
- `RoomManager`: ルーム作成・参加管理
- `TcrpProtocol`: TCRP メッセージ処理
- `RoomClient`: ルーム対応クライアント

### ファイル構成
```
src/
├── Server/
│   ├── UdpServer.php      # Real-time messaging
│   └── TcpServer.php      # Room management
├── Client/
│   ├── CliClient.php      # Basic client
│   └── RoomClient.php     # Room-aware client
├── Common/
│   ├── Protocol/
│   │   ├── UdpProtocol.php
│   │   └── TcrpProtocol.php
│   └── Models/
│       └── ChatRoom.php
```

## 🧪 テスト計画

### 単体テスト
- [ ] TCRPヘッダー解析テスト
- [ ] 操作コード処理テスト
- [ ] ルーム作成・参加ロジックテスト
- [ ] エラーハンドリングテスト

### 統合テスト
- [ ] TCP/UDP デュアルプロトコル連携テスト
- [ ] ルーム作成フローテスト
- [ ] ルーム参加フローテスト
- [ ] 複数ルーム同時運用テスト

### パフォーマンステスト
- [ ] 500+ 同時ルーム処理テスト
- [ ] 大量メッセージ処理テスト
- [ ] メモリ使用量監視テスト

## ✅ 完了基準
- [ ] TCPサーバでルーム管理ができる
- [ ] UDPサーバでメッセージングができる
- [ ] 両プロトコルが連携して動作する
- [ ] トークンベース認証が実装されている
- [ ] ホスト権限管理が実装されている
- [ ] 全てのテストが通過している
- [ ] パフォーマンス要件を満たしている
- [ ] コードレビューが完了している
- [ ] ドキュメントが更新されている

## 🏷️ 固定ラベル
この issue には以下のラベルが自動で付与されます:
- `task`: 実装タスク
- `stage-2`: ステージ2関連

### 追加ラベル（該当するものを選択）
- [ ] `server`: サーバ関連
- [ ] `client`: クライアント関連
- [ ] `protocol`: プロトコル関連
- [ ] `priority-high`: 高優先度
- [ ] `priority-medium`: 中優先度
- [ ] `priority-low`: 低優先度

## 📊 見積もり
**予想作業時間**: [例: 6-12時間]
**難易度**: [例: 高]

## 📚 参考資料
- [PHP Socket Documentation](https://www.php.net/manual/en/book.sockets.php)
- [PHP pack/unpack Documentation](https://www.php.net/manual/en/function.pack.php)
- 設計書: `CLAUDE.md`
- ステージ1実装: 依存する基本UDPチャット機能

## 🔗 依存関係
**前提タスク**: [例: ステージ1のUDPチャット機能が完了している必要がある]
**後続タスク**: [例: このタスク完了後にGUI実装またはステージ3を開始可能]