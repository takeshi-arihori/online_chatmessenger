# 実装計画

## ステージ1: 基本UDPチャット機能

- [ ] 1. プロジェクト構造とコア インターフェースの設定
  - サーバ、クライアント、共通ユーティリティ用のディレクトリ構造を作成
  - PHP8.3のcomposer.jsonとオートローダー設定を定義
  - 基本的なnamespace構造を設定
  - _要件: 1.1, 2.1_

- [ ] 2. UDPメッセージプロトコルの実装
  - メッセージフォーマット解析機能を実装（usernamelen + username + message）
  - PHP8.3のmb_string関数を使用したUTF-8エンコード・デコード処理を実装
  - PHPUnitを使用したプロトコル解析の単体テストを作成
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 3. 基本UDPサーバの実装
  - socket_create()でUDPソケットを作成し、指定ポートでリスニングする機能を実装
  - socket_recvfrom()で着信メッセージを受信し、プロトコルに従って解析する機能を実装
  - サーバ起動・停止の基本機能を実装
  - _要件: 1.1, 1.2, 1.3_

- [ ] 4. クライアント管理システムの実装
  - ClientManagerクラスを実装（アクティブクライアントの追跡）
  - クライアント追加・削除・更新機能を実装
  - 最後のメッセージ送信時刻による非アクティブクライアント検出を実装
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 5. メッセージブロードキャスト機能の実装
  - 受信メッセージを全アクティブクライアントにリレーする機能を実装
  - 送信者を除外したブロードキャスト機能を実装
  - メッセージサイズ制限（4096バイト）の実装
  - _要件: 2.3, 2.2_

- [ ] 6. 基本CLIクライアントの実装
  - UDPソケットでサーバに接続する機能を実装
  - ユーザー名入力とメッセージ送信機能を実装
  - 受信メッセージの表示機能を実装
  - _要件: 2.1, 2.4_

- [ ] 7. 非同期メッセージ処理の実装
  - クライアントでの送信・受信の並行処理を実装
  - サーバでの複数クライアント同時処理を実装
  - pcntl_fork()またはReactPHPを使用した非同期処理を実装
  - _要件: 8.1, 8.2_

- [ ] 8. エラーハンドリングとロバストネスの実装
  - ネットワークエラー処理を実装
  - 不正なメッセージフォーマットの処理を実装
  - クライアント切断の適切な処理を実装
  - _要件: 4.2, 4.3_

- [ ] 9. ステージ1統合テストの作成
  - 複数クライアント同時接続テストを作成
  - メッセージブロードキャスト機能のテストを作成
  - パフォーマンステスト（基本的な負荷テスト）を作成
  - _要件: 8.1, 8.2_

## ステージ2: チャットルーム機能

- [ ] 10. TCRPプロトコルの実装
  - TCRP（TCP Chat Room Protocol）メッセージフォーマットを実装
  - pack()/unpack()を使用した32バイトヘッダー（RoomNameSize, Operation, State, OperationPayloadSize）の解析を実装
  - 操作コード（1: ルーム作成, 2: ルーム参加）の処理を実装
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 11. TCPルーム管理サーバの実装
  - socket_create()でTCPソケットを作成し、socket_accept()でクライアント接続を受け入れる機能を実装
  - TCRPプロトコルに基づくリクエスト処理を実装
  - 状態管理（リクエスト→応答→完了）を実装
  - _要件: 5.1, 5.2_

- [ ] 12. トークン生成・管理システムの実装
  - 一意のクライアントトークン生成機能を実装
  - トークンとIPアドレスの関連付け機能を実装
  - トークン検証機能を実装
  - _要件: 5.2, 5.3_

- [ ] 13. チャットルーム管理システムの実装
  - RoomManagerクラスを実装（ルーム作成・削除・管理）
  - ホスト権限管理を実装
  - ルーム内クライアント管理を実装
  - _要件: 5.4_

- [ ] 14. 拡張UDPメッセージプロトコルの実装
  - ルーム名とトークンを含むメッセージフォーマットを実装
  - RoomNameSize + TokenSize + RoomName + Token + Messageの解析を実装
  - ルーム内メッセージブロードキャスト機能を実装
  - _要件: 5.3_

- [ ] 15. TCRPクライアントの実装
  - ルーム作成リクエスト機能を実装
  - ルーム参加リクエスト機能を実装
  - TCPレスポンス処理とトークン取得を実装
  - _要件: 5.1, 5.2_

- [ ] 16. 統合クライアント（TCP + UDP）の実装
  - TCP接続でルーム操作後、UDP接続でチャット機能を実装
  - ルーム選択UI（作成 or 参加）を実装
  - トークンを使用したUDPメッセージ送信を実装
  - _要件: 5.1, 5.2, 5.3_

- [ ] 17. ホスト退出時のルーム閉鎖機能の実装
  - ホストクライアントの切断検出を実装
  - ルーム自動閉鎖とクライアント通知を実装
  - 残りクライアントの適切な処理を実装
  - _要件: 5.4_

- [ ] 18. ステージ2統合テストの作成
  - 複数ルーム同時運用テストを作成
  - トークン認証システムのテストを作成
  - ルーム作成・参加・退出フローのテストを作成
  - _要件: 8.3_

## ステージ3: 高度な機能

- [ ] 19. パスワード保護機能の実装
  - JSONペイロード形式への移行を実装
  - ルーム作成時のパスワード設定機能を実装
  - ルーム参加時のパスワード認証を実装
  - _要件: 7.1_

- [ ] 20. RSA暗号化システムの実装
  - openssl_pkey_new()を使用したRSA鍵ペア生成機能を実装
  - openssl_public_encrypt()/openssl_private_decrypt()を使用したメッセージ暗号化・復号化機能を実装
  - 公開鍵交換プロトコルを実装
  - _要件: 7.3, 7.4_

- [ ] 21. 暗号化通信の統合
  - サーバ・クライアント間の鍵交換を実装
  - 全メッセージの暗号化処理を実装
  - 暗号化エラーハンドリングを実装
  - _要件: 7.3, 7.4_

- [ ] 22. Electron.jsプロジェクトの設定
  - Node.jsとElectron.jsの基本プロジェクト構造を作成
  - メインプロセスとレンダラープロセスの設定を実装
  - 基本的なHTMLとCSSでのUI骨格を作成
  - _要件: 7.2_

- [ ] 23. GUIクライアントのネットワーク機能実装
  - Node.jsでのTCP/UDP通信機能を実装
  - TCRPプロトコルのJavaScript実装を作成
  - Node.jsのcryptoモジュールを使用した暗号化機能のJavaScript実装を作成
  - _要件: 7.2_

- [ ] 24. GUIクライアントのユーザーインターフェース実装
  - ルーム作成・参加画面を実装
  - チャット画面（メッセージ表示・入力）を実装
  - ユーザーリスト表示機能を実装
  - _要件: 7.2_

- [ ] 25. GUIとCLIクライアントの互換性テスト
  - GUIクライアントとCLIクライアント間の通信テストを作成
  - 暗号化通信の相互運用性テストを作成
  - 混在環境でのチャットルーム機能テストを作成
  - _要件: 7.2, 7.3_

- [ ] 26. パフォーマンス最適化の実装
  - 10,000パケット/秒処理能力の検証と最適化を実装
  - メモリ使用量の最適化を実装
  - 並行処理性能の向上を実装
  - _要件: 8.1, 8.2, 8.3_

- [ ] 27. 包括的なエラーハンドリングの実装
  - 暗号化エラーの処理を実装
  - GUI特有のエラー処理を実装
  - ネットワーク障害時の復旧機能を実装
  - _要件: 7.3, 7.4_

- [ ] 28. 最終統合テストとドキュメント作成
  - PHPUnitを使用した全ステージ機能の統合テストを作成
  - パフォーマンステスト（500ルーム、各10人、毎秒2メッセージ）を実行
  - ユーザーマニュアルとAPI仕様書を作成
  - _要件: 8.3, 9.1, 9.2, 9.3_
